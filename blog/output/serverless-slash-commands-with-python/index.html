<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Serverless Slash Commands withÂ Python</title>
        <meta name="description" content="Building serverless Slack slash commands with Python.">

        <style type="text/css">
*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-weight:300;font-size:16px;line-height:1.5}@media (min-width: 58em){html{font-size:20px}}body{color:rgba(0,0,0,0.87);background-color:#fff;-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-rendering:optimizeLegibility}a{color:rgba(33,150,243,0.87);text-decoration:none;-webkit-transition:color 250ms ease;-moz-transition:color 250ms ease;-ms-transition:color 250ms ease;-o-transition:color 250ms ease;transition:color 250ms ease}a strong{color:inherit}a:hover,a:focus{color:rgba(43,90,172,0.87)}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:400;line-height:1.25}h1{font-size:2rem}h2{margin-top:1rem;font-size:1.5rem}h3{margin-top:1.5rem;font-size:1.25rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:400}dd{margin-bottom:.5rem}.list-unstyled{padding-left:0;list-style:none}code,pre{font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,Courier,monospace;text-rendering:optimizeSpeed}code{font-weight:700;font-size:90%}pre{font-weight:400;display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;overflow:auto;word-wrap:normal;white-space:pre;background-color:rgba(0,0,0,0.05)}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:rgba(0,0,0,0.54);border-left:0.25rem solid rgba(0,0,0,0.12)}blockquote p:last-child{margin-bottom:0}@media (min-width: 30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img,video{display:block;max-width:100%;margin:0 0 1rem}table{margin-bottom:1rem;width:100%;background-color:transparent;border-collapse:collapse}th,td{padding:0.3rem;vertical-align:top;border-top:1px solid #eceeef;text-align:left}.rows th{width:30%}.rows td{width:70%}.rows tr:first-child th,.rows tr:first-child td{border-top:none}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid rgba(0,0,0,0.12);border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:400;color:rgba(0,0,0,0.87);text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted rgba(0,0,0,0.12)}.lead{margin-bottom:1rem;font-size:1.2rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:rgba(0,0,0,0.54);background-color:rgba(0,0,0,0.05)}.title{margin-bottom:0}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.content{padding-top:2rem;padding-bottom:2rem}@media (min-width: 58em){.content{max-width:38rem;margin-left:20rem;margin-right:2rem;padding-top:3rem;padding-bottom:3rem}}@media (min-width: 64em){.content{margin-left:22rem;margin-right:4rem;padding-top:3rem;padding-bottom:3rem}}@media not print{.print-resume-intro{display:none}}@media print{html{font-size:12px}.content{max-width:100%;margin:0rem 3rem;padding:0}.sidebar,.web-resume-intro{display:none}}.post,.page{margin-bottom:2em}.post-title,.post-title a,.page-title{font-weight:400;color:rgba(0,0,0,0.87);-webkit-transition:color 250ms ease;-moz-transition:color 250ms ease;-ms-transition:color 250ms ease;-o-transition:color 250ms ease;transition:color 250ms ease}.post-title a:hover,.post-title a:focus{color:rgba(33,150,243,0.87)}.post-title,.page-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:rgba(0,0,0,0.54)}.coffee{font-weight:400}.related{padding-top:1rem;font-weight:400;border-top:1px solid rgba(0,0,0,0.12)}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-weight:300;font-size:75%;color:rgba(0,0,0,0.54)}.project{margin-top:1rem;margin-bottom:1.5rem}.project-title a{font-weight:400}.sidebar{text-align:center;padding:1rem 1rem;color:rgba(255,255,255,0.54);background-color:#000}.logo{height:5rem;display:block;margin:0 auto 1rem}@media (min-width: 58em){.sidebar{position:fixed;top:0;left:0;bottom:0;width:18rem;text-align:left}.logo{height:15rem;margin-left:0}}.sidebar-about h1 a{margin-top:0}.sidebar a{color:rgba(255,255,255,0.87);-webkit-transition:color 250ms ease;-moz-transition:color 250ms ease;-ms-transition:color 250ms ease;-o-transition:color 250ms ease;transition:color 250ms ease}.sidebar a:hover,.sidebar a:focus{color:#fff}.sidebar-nav{margin-bottom:1rem}.sidebar-nav-item{display:block;line-height:1.75}.sidebar-nav-item.active{font-weight:400}@media (min-width: 58em){.sidebar-sticky{position:absolute;right:1rem;bottom:1rem;left:1rem}}.tagline{display:none}@media (min-width: 58rem){.tagline{display:block}}#menu-icon{display:none}.collapsable{display:none;padding-top:0.5rem}input[type=checkbox]:checked ~ .collapsable{display:block}input[type=checkbox] ~ .menu-label:after{content:"Menu"}input[type=checkbox]:checked ~ .menu-label:after{content:"Collapse"}@media (min-width: 58rem){.menu-label{display:none}.collapsable{display:block;padding-top:inherit}}.copyright{display:none}@media (min-width: 58rem){.copyright{font-size:0.75em;font-weight:100;display:block}}.blue-grey-theme .sidebar{background-color:#607d8b}.blue-grey-theme .post-title a,.blue-grey-theme .project-title a,.blue-grey-theme .related-posts a{color:rgba(96,125,139,0.87);-webkit-transition:color 250ms ease;-moz-transition:color 250ms ease;-ms-transition:color 250ms ease;-o-transition:color 250ms ease;transition:color 250ms ease}.blue-grey-theme .post-title a:hover,.blue-grey-theme .post-title a:focus,.blue-grey-theme .project-title a:hover,.blue-grey-theme .project-title a:focus,.blue-grey-theme .related-posts a:hover,.blue-grey-theme .related-posts a:focus{color:rgba(43,90,172,0.87)}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.highlight .hll{background-color:#ffc}.highlight .c{color:#408080}.highlight .err{border:1px solid red}.highlight .k{color:#008000;font-weight:700}.highlight .o{color:#666}.highlight .cm{color:#408080;font-style:italic}.highlight .cp{color:#BC7A00}.highlight .c1{color:#408080;font-style:italic}.highlight .cs{color:#408080;font-style:italic}.highlight .gd{color:#A00000}.highlight .ge{font-style:italic}.highlight .gr{color:red}.highlight .gh{color:#000080;font-weight:700}.highlight .gi{color:#00A000}.highlight .go{color:gray}.highlight .gp{color:#000080;font-weight:700}.highlight .gs{font-weight:700}.highlight .gu{color:#800080;font-weight:700}.highlight .gt{color:#0040D0}.highlight .kc{color:#008000;font-weight:700}.highlight .kd{color:#008000;font-weight:700}.highlight .kn{color:#008000;font-weight:700}.highlight .kp{color:green}.highlight .kr{color:#008000;font-weight:700}.highlight .kt{color:#B00040}.highlight .m{color:#666}.highlight .s{color:#BA2121}.highlight .na{color:#7D9029}.highlight .nb{color:green}.highlight .nc{color:#0000FF;font-weight:700}.highlight .no{color:#800}.highlight .nd{color:#a2f}.highlight .ni{color:#999999;font-weight:700}.highlight .ne{color:#D2413A;font-weight:700}.highlight .nf{color:blue}.highlight .nl{color:#A0A000}.highlight .nn{color:#0000FF;font-weight:700}.highlight .nt{color:#008000;font-weight:700}.highlight .nv{color:#19177C}.highlight .ow{color:#AA22FF;font-weight:700}.highlight .w{color:#bbb}.highlight .mf{color:#666}.highlight .mh{color:#666}.highlight .mi{color:#666}.highlight .mo{color:#666}.highlight .sb{color:#BA2121}.highlight .sc{color:#BA2121}.highlight .sd{color:#BA2121;font-style:italic}.highlight .s2{color:#BA2121}.highlight .se{color:#BB6622;font-weight:700}.highlight .sh{color:#BA2121}.highlight .si{color:#BB6688;font-weight:700}.highlight .sx{color:green}.highlight .sr{color:#b68}.highlight .s1{color:#BA2121}.highlight .ss{color:#19177C}.highlight .bp{color:green}.highlight .vc{color:#19177C}.highlight .vg{color:#19177C}.highlight .vi{color:#19177C}.highlight .il{color:#666}        </style>

        <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
        <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="/manifest.json">
        <meta name="msapplication-TileColor" content="#607d8b">
        <meta name="msapplication-TileImage" content="/mstile-144x144.png">
        <meta name="theme-color" content="#607d8b">

        <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-33031883-4', 'auto');

            ga('send', 'pageview', {
                page: location.pathname + location.search
            });
        </script>
    </head>

    <body class="blue-grey-theme">
        <div class="sidebar">
            <div class="container sidebar-sticky">
                <div class="sidebar-about">
                    <h1>
                        <a href="/">
<svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 350" version="1.1"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M200 305L200 260C200 227.2 185.7 197.8 163 177.7 185.6 159.4 200 131.4 200 100 200 44.8 155.2 0 100 0L50 0 0 0 0 25 0 50 100 50C127.6 50 150 72.4 150 100 150 127.6 127.6 150 100 150L0 150 0 200 95 200C125.4 200 150 224.6 150 255L150 345C150 346.7 149.9 348.4 149.8 350L174.9 350 200 350 200 305 200 305ZM0 150L50 150 50 200 0 200 0 150Z" fill="#FFFFFF" opacity="0.9"/></g></svg>                        </a>
                    </h1>
                    <p class="tagline lead">Renzo Lucioni's personal website and portfolio.</p>
                </div>

                <input type="checkbox" id="menu-icon">
                <label class="menu-label" for="menu-icon"></label>

                <div class="collapsable">
                    <nav class="sidebar-nav">
                        <a class="sidebar-nav-item" href="/">Home</a>

                        <a class="sidebar-nav-item" href="/about">About</a>

                        <a class="sidebar-nav-item" href="/projects">Projects</a>

                        <a class="sidebar-nav-item profile outbound" href="https://github.com/rlucioni">GitHub</a>
                    </nav>
                </div>

                <p class="copyright">&copy; 2013&ndash;2018 Renzo Lucioni</p>
            </div>
        </div>

        <div class="content container">
<div class="post">
    <h1 class="post-title">Serverless Slash Commands with&nbsp;Python</h1>
    <span class="post-date">March 5, 2018</span>
    <p>Slack&#8217;s <a href="https://api.slack.com/slash-commands">slash commands</a> allow you to perform actions by typing commands into Slack. Custom slash commands are a nice way to add your own functionality to Slack. Here&#8217;s a way to build them with Python, host them for pennies a month on <span class="caps">AWS</span> Lambda, and use these same tools to issue <a href="https://api.slack.com/slash-commands#delayed_responses_and_multiple_responses">delayed responses</a> when creating long-running&nbsp;commands.</p>
<h2>Setup</h2>
<p>Custom slash commands require a <a href="https://api.slack.com/slack-apps">Slack app</a>. To get started, go <a href="https://api.slack.com/slack-apps">here</a> to create one. Once you&#8217;ve created it, scroll down to the &#8220;App Credentials&#8221; section and make note of your app&#8217;s verification token, shown highlighted below. You&#8217;ll need it&nbsp;later.</p>
<p><img alt="App credentials" src="/images/hello-there-app-credentials.png"></p>
<p>You&#8217;re going to create a command invoked with <code>/hello-there</code> which responds with <a href="https://youtu.be/frszEJb0aOo">&#8220;General Kenobi!&#8221;</a> whenever the command is run. Navigate to the &#8220;Slash Commands&#8221; section and click &#8220;Create New Command.&#8221; Fill in the information shown below and save the&nbsp;form.</p>
<p><img alt="New command configuration" src="/images/hello-there-new-command.png"></p>
<p>The Request <span class="caps">URL</span> you&#8217;re providing here is a placeholder. You&#8217;ll come back and update it soon. For now, the last step is to install the app in your Slack workspace. Go back to your app&#8217;s &#8220;Basic Information&#8221; page, click &#8220;Install App to Workspace,&#8221; and authorize the&nbsp;app.</p>
<p><img alt="App authorization" src="/images/hello-there-authorize-app.png"></p>
<p>You should now be able to open Slack and see your slash command autocomplete as you type <code>/hello</code>.</p>
<p><img alt="Command autocomplete" src="/images/hello-there-autocomplete.png"></p>
<p>Sadly, your command doesn&#8217;t respond the way you want it to yet. Let&#8217;s change&nbsp;that.</p>
<h2>Development</h2>
<p>You&#8217;ll use <a href="http://flask.pocoo.org/">Flask</a> to implement a simple backend for your slash command. Start by creating a virtual environment, activating it, and installing Flask. I happen to use <a href="https://github.com/yyuu/pyenv"><code>pyenv</code></a> and manage my virtualenvs with <a href="https://github.com/yyuu/pyenv-virtualenv"><code>pyenv-virtualenv</code></a>.</p>
<div class="highlight"><pre><span></span>$ pyenv virtualenv <span class="m">3</span>.6.4 hello-there
$ pyenv <span class="nb">local</span> hello-there
<span class="o">(</span>hello-there<span class="o">)</span>$ pip install flask
</pre></div>


<p>Creating a virtualenv for new projects is generally a good idea. It&#8217;s especially important here because you&#8217;re going to use it to make sure that your app&#8217;s dependencies are shipped to <span class="caps">AWS</span> Lambda. More on that&nbsp;later.</p>
<p>Now let&#8217;s write the backend for your command. The backend needs to do 3 things: receive a <span class="caps">POST</span> request, verify that the request was issued by Slack, and respond with the desired message. Here&#8217;s how that might look, in a file called <code>hello-there.py</code>.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_request_valid</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">is_token_valid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLACK_VERIFICATION_TOKEN&#39;</span><span class="p">]</span>
    <span class="n">is_team_id_valid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;team_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLACK_TEAM_ID&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">is_token_valid</span> <span class="ow">and</span> <span class="n">is_team_id_valid</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/hello-there&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">hello_there</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_request_valid</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span>
        <span class="n">response_type</span><span class="o">=</span><span class="s1">&#39;in_channel&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&lt;https://youtu.be/frszEJb0aOo|General Kenobi!&gt;&#39;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>


<p><code>SLACK_VERIFICATION_TOKEN</code> is your app&#8217;s verification token from before. <code>SLACK_TEAM_ID</code> is exactly what it sounds like. A quick way to find your Slack team <span class="caps">ID</span> is to open the Slack web client in your browser, inspect the source using the dev tools, and search for <code>team_id</code>.</p>
<p><img alt="Finding your team ID" src="/images/hello-there-team-id.png"></p>
<p>See Slack&#8217;s <a href="https://api.slack.com/slash-commands#validating_the_command">command validation</a> docs for more details about what&#8217;s going on in <code>is_request_valid()</code>. See the <a href="https://api.slack.com/docs/message-formatting#linking_to_urls">link formatting</a> docs for more information about the format of your&nbsp;message.</p>
<p>Run the app like you would any other Flask app while exporting the environment variables it&nbsp;needs.</p>
<div class="highlight"><pre><span></span>(hello-there)$ SLACK_VERIFICATION_TOKEN=your-verification-token SLACK_TEAM_ID=your-team-id FLASK_APP=hello-there.py flask run
</pre></div>


<p>The app will run on port 5000 by default. If you have <a href="https://ngrok.com/">ngrok</a> installed, you can test the command from Slack at this point. Leave the server running and start ngrok in a separate&nbsp;process.</p>
<div class="highlight"><pre><span></span>$ ngrok http <span class="m">5000</span>
</pre></div>


<p>Copy the <span class="caps">HTTPS</span> forwarding <span class="caps">URL</span>, shown highlighted&nbsp;below.</p>
<p><img alt="Using ngrok" src="/images/hello-there-ngrok.png"></p>
<p>In your browser, navigate back to your app&#8217;s &#8220;Slash Commands&#8221; section. Edit the command you created earlier, replacing the Request <span class="caps">URL</span> with the ngrok forwarding <span class="caps">URL</span> and the path to your app&#8217;s <code>/hello-there</code> endpoint, as shown&nbsp;below.</p>
<p><img alt="ngrok request URL" src="/images/hello-there-ngrok-url.png"></p>
<p>Save your change, then try invoking the command in Slack. You should see something like the&nbsp;following.</p>
<p><img alt="Command demo" src="/images/hello-there-demo.png"></p>
<p>It works! Time to ship&nbsp;it.</p>
<h2>Deployment</h2>
<p>Slash commands are event-driven by nature. As such, they lend themselves well to serverless deployment. In other words, the server running the backend for your slash commands doesn&#8217;t need to be running all the time. If it was, you&#8217;d end up paying for a server that spent most of its time doing nothing. Services like <span class="caps">AWS</span> Lambda are a cheap and convenient way to run small, event-driven apps like this&nbsp;one.</p>
<p>You&#8217;re going to use a Python framework called <a href="https://github.com/Miserlou/Zappa">Zappa</a> to deploy your Flask app to Lambda. Zappa creates a Lambda function containing your Flask app and sets up a wildcard <span class="caps">API</span> Gateway route to proxy requests from Slack to the app. This allows the app to use Flask&#8217;s regular <span class="caps">URL</span> routing as if you were running it locally or in a more traditional setting. To get started, install&nbsp;Zappa.</p>
<div class="highlight"><pre><span></span>(hello-there)$ pip install zappa
</pre></div>


<p>If you haven&#8217;t already, create a local <a href="https://aws.amazon.com/blogs/security/a-new-and-standardized-way-to-manage-credentials-in-the-aws-sdks/"><span class="caps">AWS</span> credentials file</a> (e.g., <code>~/.aws/credentials</code>). Zappa needs this file to sign requests to <span class="caps">AWS</span>.</p>
<p>Now let&#8217;s define a simple Zappa settings file called <code>zappa_settings.json</code>.</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;prod&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;app_function&quot;</span><span class="p">:</span> <span class="s2">&quot;hello-there.app&quot;</span><span class="p">,</span>
        <span class="nt">&quot;aws_region&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;exclude&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;__pycache__&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.git/*&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.gitignore&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.python-version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LICENSE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;README.md&quot;</span><span class="p">,</span>
            <span class="s2">&quot;requirements.txt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;zappa_settings.json&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="nt">&quot;keep_warm&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;keep_warm_expression&quot;</span><span class="p">:</span> <span class="s2">&quot;rate(5 minutes)&quot;</span><span class="p">,</span>
        <span class="nt">&quot;memory_size&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="nt">&quot;profile_name&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="nt">&quot;project_name&quot;</span><span class="p">:</span> <span class="s2">&quot;hello-there&quot;</span><span class="p">,</span>
        <span class="nt">&quot;runtime&quot;</span><span class="p">:</span> <span class="s2">&quot;python3.6&quot;</span><span class="p">,</span>
        <span class="nt">&quot;s3_bucket&quot;</span><span class="p">:</span> <span class="s2">&quot;hello-there&quot;</span><span class="p">,</span>
        <span class="nt">&quot;timeout_seconds&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>These settings tell Zappa where to find your app, what you want to prevent from being uploaded to <span class="caps">AWS</span>, and how to configure the resulting Lambda function. The <code>keep_warm</code> setting tells Zappa whether you want it to set up a recurring no-op that keeps your app function warm. This prevents the function from wasting valuable seconds cold-starting and hitting Slack&#8217;s 3-second <a href="https://api.slack.com/slash-commands#responding_to_a_command">slash command timeout</a>.</p>
<p>With your settings file in place, you&#8217;re ready to deploy your app to <span class="caps">AWS</span>. Do so as&nbsp;follows.</p>
<div class="highlight"><pre><span></span>(hello-there)$ zappa deploy prod
</pre></div>


<p>This tells Zappa to zip up your code and virtualenv, upload the package, create a new Lambda function, and create a new <span class="caps">API</span> Gateway route pointing to the function. Wait a few moments for all this to happen and your app should be deployed! Head over to the <span class="caps">AWS</span> console in your browser, navigate to the Lambda service, and you should see your new function&nbsp;listed.</p>
<p><img alt="Lambda function listing" src="/images/hello-there-function-listing.png"></p>
<p>Click into the function and scroll down to configure the app&#8217;s environment&nbsp;variables.</p>
<p><img alt="Lambda function environment variables" src="/images/hello-there-env-vars.png"></p>
<p>Don&#8217;t forget to click &#8220;Save&#8221; in the upper-right. All you need to do now is tell Slack to send <span class="caps">POST</span> requests to your newly-deployed app. You need to replace the ngrok forwarding <span class="caps">URL</span> from earlier with your app&#8217;s new <span class="caps">API</span> Gateway <span class="caps">URL</span>. To find it, run the following for details about your&nbsp;deployment.</p>
<div class="highlight"><pre><span></span>(hello-there)$ zappa status prod
Status for hello-there-prod: 
    Lambda Versions:      2
    Lambda Name:          hello-there-prod
    Lambda ARN:           arn:aws:lambda:us-east-1:635361345619:function:hello-there-prod
    Lambda Role ARN:      arn:aws:iam::635361345619:role/hello-there-prod-ZappaLambdaExecutionRole
    Lambda Handler:       handler.lambda_handler
    Lambda Code Size:     10720718
    Lambda Version:       $LATEST
    Lambda Last Modified: 2018-03-05T01:35:46.933+0000
    Lambda Memory Size:   128
    Lambda Timeout:       30
    Lambda Runtime:       python3.6
    Lambda VPC ID:        None
    Invocations (24h):    0
    Errors (24h):         0
    Error Rate (24h):     0.00%
    API Gateway URL:      https://f5y9jiq8s3.execute-api.us-east-1.amazonaws.com/prod
    Domain URL:           None Supplied
    Num. Event Rules:     1
    Event Rule Name:      hello-there-prod-zappa-keep-warm-handler.keep_warm_callback
    Event Rule Schedule:  rate(5 minutes)
    Event Rule State:     Enabled
    Event Rule ARN:       arn:aws:events:us-east-1:635361345619:rule/hello-there-prod-zappa-keep-warm-handler.keep_warm_callback
</pre></div>


<p>Copy the <span class="caps">API</span> Gateway <span class="caps">URL</span>. Then, just like before, navigate back to your app&#8217;s &#8220;Slash Commands&#8221; section in your browser and edit the configuration of the <code>/hello-there</code> command, replacing the ngrok forwarding <span class="caps">URL</span> with the <span class="caps">API</span> Gateway <span class="caps">URL</span>.</p>
<p><img alt="Lambda request URL" src="/images/hello-there-lambda-url.png"></p>
<p>Remember to leave the <code>/hello-there</code> portion of the path intact so that Slack POSTs to the right endpoint. Save your change, then try invoking the command in Slack again. Your app should respond, just like when it was running locally. If it doesn&#8217;t, tail the function&#8217;s logs to figure out what&#8217;s going&nbsp;wrong.</p>
<div class="highlight"><pre><span></span>(hello-there)$ zappa tail prod --since 1h
</pre></div>


<p>Assuming your app responds successfully, congratulations! You&#8217;ve created your own slash&nbsp;command.</p>
<h2>Delayed&nbsp;Responses</h2>
<p>Slack requires that &#8220;in channel&#8221; slash commands receive a response <a href="https://api.slack.com/slash-commands#responding_to_a_command">within 3 seconds</a>. Your app is already using Zappa&#8217;s <a href="https://github.com/Miserlou/Zappa#keeping-the-server-warm">keep-warm</a> feature to combat cold-start and keep its response times under this limit. Here&#8217;s how you can implement a command that takes longer than 3 seconds to complete using Zappa&#8217;s <a href="https://github.com/Miserlou/Zappa#asynchronous-task-execution">asynchronous task execution</a> feature. This section doubles as an example of how to update the code your deployed function is&nbsp;running.</p>
<p>To be more faithful to the scene from Revenge of the Sith, you now want your <code>/hello-there</code> command to respond with <a href="https://youtu.be/frszEJb0aOo">&#8220;General Kenobi!&#8221;</a>, followed 5 seconds later by &#8220;You <em>are</em> a bold one.&#8221; Your command&#8217;s backend has to do more work now: receive a <span class="caps">POST</span> request, verify that the request was issued by Slack, schedule a task that will issue the second message 5 seconds in the future, and respond immediately with the first message. Here&#8217;s how you might change your implementation of <code>hello-there.py</code> to achieve&nbsp;this.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">zappa.async</span> <span class="kn">import</span> <span class="n">task</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_request_valid</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">is_token_valid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLACK_VERIFICATION_TOKEN&#39;</span><span class="p">]</span>
    <span class="n">is_team_id_valid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;team_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLACK_TEAM_ID&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">is_token_valid</span> <span class="ow">and</span> <span class="n">is_team_id_valid</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">hello_there_task</span><span class="p">(</span><span class="n">response_url</span><span class="p">):</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;in_channel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;You _are_ a bold one.&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">response_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/hello-there&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">hello_there</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_request_valid</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>

    <span class="n">hello_there_task</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;response_url&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span>
        <span class="n">response_type</span><span class="o">=</span><span class="s1">&#39;in_channel&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&lt;https://youtu.be/frszEJb0aOo|General Kenobi!&gt;&#39;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>


<p>The <code>@task</code> decorator tells Zappa to run <code>hello_there_task()</code> asynchronously as a separate, one-off Lambda function. As a result, <code>hello_there_task()</code> should return immediately in spite of the blocking, 5-second sleep. When run locally, the task will execute&nbsp;synchronously.</p>
<p>Let&#8217;s deploy and test these changes. The following command tells Zappa that you want to upload new Python code, but that you don&#8217;t need to touch existing <span class="caps">API</span> Gateway&nbsp;routes.</p>
<div class="highlight"><pre><span></span>(hello-there)$ zappa update prod
</pre></div>


<p>Wait a few moments for your Lambda function to update. An update like this won&#8217;t change your function&#8217;s <span class="caps">API</span> Gateway <span class="caps">URL</span>, so you don&#8217;t need to touch your slash command configuration again. Once the update completes, try invoking your command in Slack a final time. Here&#8217;s how it should look, in real&nbsp;time.</p>
<video src="/images/hello-there.mp4" muted autoplay loop></video>

<p>Awesome!</p>
<h2>Tips</h2>
<p>I&#8217;ll end with a few additional&nbsp;tips.</p>
<h3>Slash Command Best&nbsp;Practices</h3>
<p>Slack lists a variety of slash command <a href="https://api.slack.com/slash-commands#best_practices">best practices</a> in their docs. Two in particular have served me&nbsp;well.</p>
<p>First, provide a help action that explains your command&#8217;s usage. For example, look for the word <code>help</code> in the request&#8217;s <code>text</code> parameter and respond&nbsp;accordingly.</p>
<p>Second, try to acknowledge receipt of commands by responding immediately, even if the command hasn&#8217;t completed yet. This is especially important if the command will take some time to run. An immediate response lets your users know that their request was received and is being acted&nbsp;on.</p>
<h3>Cost</h3>
<p>You&#8217;re probably wondering how much this costs. Here&#8217;s the February 2018 bill for an app of mine that backs a handful of slash commands similar to your <code>/hello-there</code> command.</p>
<p><img alt="AWS bill" src="/images/hello-there-cost.png"></p>
<p>Not bad! I&#8217;m able to keep the cost low by taking advantage of Lambda&#8217;s <a href="https://aws.amazon.com/lambda/pricing/#Lambda_pricing_details">free tier</a>. The 128 <span class="caps">MB</span> memory size requested in <code>zappa_settings.json</code> is the smallest available and allows functions to run for a total of 3.2 million free seconds each&nbsp;month.</p>
<h3>Lambda&nbsp;Versioning</h3>
<p>Every time you update a function, a new version of it is created. <span class="caps">AWS</span> keeps old versions around unless you delete them. Zappa won&#8217;t delete old versions for&nbsp;you.</p>
<p>Things can get messy if you leave lots of old function versions lying around. It also means you&#8217;re leaving old deployment packages around. <span class="caps">AWS</span> <a href="https://docs.aws.amazon.com/lambda/latest/dg/limits.html#limits-list">limits</a> the total size of all deployment packages that can be uploaded per region, though you&#8217;re unlikely to hit the&nbsp;limit.</p>
<p>To clean up function versions manually, navigate to the <span class="caps">AWS</span> console. Select the version you want to&nbsp;delete.</p>
<p><img alt="Lambda versions" src="/images/hello-there-versions.png"></p>
<p>Then click &#8220;Delete version&#8221; from the&nbsp;menu.</p>
<p><img alt="Delete Lambda version" src="/images/hello-there-delete-version.png"></p>
<p>It&#8217;s possible to automate this, but chances are you probably won&#8217;t need to do it&nbsp;often.</p>
<h3>Cron&nbsp;Jobs</h3>
<p>Need your app to run scheduled tasks? Zappa&#8217;s <a href="https://github.com/Miserlou/Zappa/#scheduling">function scheduling</a> has you covered, making it easy to create CloudWatch Events that can trigger arbitrary functions using <a href="https://docs.aws.amazon.com/lambda/latest/dg/tutorial-scheduled-events-schedule-expressions.html">cron or rate syntax</a>.</p>
<h3>Teardown</h3>
<p>If you want to delete everything you deployed here from <span class="caps">AWS</span>, Zappa&#8217;s <a href="https://github.com/Miserlou/Zappa#undeploy">undeploy command</a> also has you&nbsp;covered.</p>
<div class="highlight"><pre><span></span>(hello-there)$ zappa undeploy prod
</pre></div>


<p>This deletes your Lambda function, its accompanying <span class="caps">API</span> Gateway route, and any CloudWatch Events. You&#8217;ll be asked to confirm before it&nbsp;runs.</p>
<h2>Examples</h2>
<p>All of the code covered here is on <a href="https://github.com/rlucioni/hello-there">GitHub</a>.</p>
<p>If you want to see a more complete example that includes help actions, asynchronous tasks, and scheduled tasks, check out my <a href="https://github.com/rlucioni/courtbot">courtbot</a>&nbsp;project.</p>
    <span class="coffee">
        Was this helpful? <a class="outbound" href="https://www.paypal.me/rlucioni/3">Buy me a coffee!</a>
    </span>
</div>

<div class="related">
    <h2>Related Posts</h2>
    <ul class="related-posts">
        <li>
            <h3>
                <a href="/python-proxy-classes/">
                    Python Proxy&nbsp;Classes
                    <small>January 20, 2017</small>
                </a>
            </h3>
        </li>
        <li>
            <h3>
                <a href="/entering-pythons-interactive-mode/">
                    Entering Python&#8217;s Interactive&nbsp;Mode
                    <small>December 14, 2016</small>
                </a>
            </h3>
        </li>
    </ul>
</div>
        </div>

        <script>
            const pdfResumeLink = document.getElementById('pdf-resume-link');
            if (pdfResumeLink) {
                pdfResumeLink.addEventListener('click', event => {
                    ga('send', 'pageview', {
                        page: event.target.pathname,
                        transport: 'beacon'
                    });
                });
            }

            const outboundLinks = document.getElementsByClassName('outbound');
            for (const link of outboundLinks) {
                link.addEventListener('click', event => {
                    ga('send', 'event', {
                        eventCategory: 'outbound',
                        eventAction: 'click',
                        eventLabel: event.target.href,
                        transport: 'beacon'
                    });
                });
            }

            const emailLink = document.getElementById('email-link');
            if (emailLink) {
                emailLink.href = 'mailto:renzo@lucioni.xyz';
                emailLink.innerHTML = 'renzo@lucioni.xyz';
            }

        </script>
    </body>
</html>